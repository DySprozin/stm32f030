#include "stm32f0xx.h"
#include "def.h"

#define I2C_SCL 9
#define I2C_SDA 10

#define TEST 5

#define COL_START       38
#define COL_END         89
#define PAGE_START      0
#define PAGE_END        7




void i2c_init(void);

volatile int lcd_on;

char arr_reset[26] =  { 0xa8,  0x3f,  0xd3,  0x00,  0x40,  0xA1, 
                       0xC8,  0xDA,  0x12,  0x81,  0xFF,  0xA4, 
                       0xA6,  0xD5,  0x80,  0x8D,  0x14,  0x20, 0x20,  0xAF, 
                       0x21,  0x00,  0x7F,  0x22,  0x00,  0x07,};

char arr_init[26] =  { 0xa8,  0x3f,  0xd3,  0x00,  0x40,  0xA1, 
                       0xC8,  0xDA,  0x12,  0x81,  0xFF,  0xA4, 
                       0xA6,  0xD5,  0x80,  0x8D,  0x14,  0x20, 0x20,  0xAF, 
                       0x21,  COL_START,  COL_END,  0x22,  PAGE_START,  PAGE_END,};

char arr_data[364] = {                0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xE0, 0xF8, 0xFC, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x3F, 0x1F, 0x3F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFC, 0xF8, 0xF0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9F, 0xF, 0x7, 0x7, 0xF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x6, 0x0, 0x0, 0x0, 0x0, 0xF, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xF, 0x7, 0x7, 0x7, 0x8F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x80, 0x0, 0x0, 0x0, 0xF, 0x87, 0x87, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0x87, 0x87, 0xF, 0x0, 0x0, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3, 0x81, 0x1, 0x1, 0x1, 0x83, 0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0x3C, 0x0, 0xF0, 0xF0, 0xF1, 0xF3, 0xF3, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF3, 0xF3, 0xF1, 0xF0, 0xF0, 0xF0
                      };
char arr_data2[364] = {                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF, 0x3, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xC0, 0xC0, 0xC0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x3, 0xF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xF0, 0xF0, 0xF0, 0xF0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xC0, 0xF0, 0xFF, 0xFF, 0xFF, 0xF9, 0xE0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xE0, 0xF0, 0xF0, 0xF0, 0x20, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x7F, 0xFF, 0xFF, 0xFE, 0xFC, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xF, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xE, 0xC, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3F, 0xFF, 0xFF, 0xEF, 0xF0, 0x70, 0x30, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x70, 0xF0, 0xE7, 0xFF, 0x83, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0x7C, 0x7E, 0x7E, 0x7E, 0x7C, 0x10, 0x0, 0x0, 0x0, 0x0, 0x81, 0xFF, 0xFF, 0xFE, 0xFC, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xFC, 0xFC, 0xFE, 0xFF, 0xFF
                      };

void main(void) {
  
 SysTick_Config(1000000); /* (1) */

 
  

  i2c_init();

      

    



/////
// RESET

  for (int arr_ch = 0; arr_ch < 26; arr_ch++) {

  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

    
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x80; 
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = arr_reset[arr_ch]; 



  

    }
  

  for (int arr_ch = 0; arr_ch < 1024; arr_ch++) {
  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x40; 


      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x00; 


    }
  
//
/////
  
  


  
 
  while(1) {
    
    
    if (lcd_on) {
/////
// data

  for (int arr_ch = 0; arr_ch < 26; arr_ch++) {

  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

    
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x80; 
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = arr_init[arr_ch]; 



  

    }
  

  for (int arr_ch = 0; arr_ch < sizeof(arr_data); arr_ch++) {
  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x40; 


      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = arr_data[arr_ch]; 


    }
  
//
/////
    }
    
    else {
/////
// data


  for (int arr_ch = 0; arr_ch < 26; arr_ch++) {

  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

    
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x80; 
      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = arr_init[arr_ch]; 



  

    }
  

  for (int arr_ch = 0; arr_ch < sizeof(arr_data); arr_ch++) {
  I2C1->CR2 = I2C_CR2_AUTOEND | (2 << 16) | (0x3C << 1) |  I2C_CR2_START;

      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = 0x40; 


      while((I2C1->ISR & I2C_ISR_TXIS) != I2C_ISR_TXIS);
      I2C1->TXDR = arr_data2[arr_ch]; 


    }
  
//
/////
    } 
}
}
void i2c_init() {
  
  RCC->AHBENR |= RCC_AHBENR_GPIOAEN;
  RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;
  
  
  
  ///////////////////////
 GPIOA->MODER |= MODER_01(TEST);
 ///////////////////////
  
  GPIOA->MODER |= MODER_10(I2C_SCL) | MODER_10(I2C_SDA);

  GPIOA->PUPDR &= ~PUPDR_11(I2C_SCL) & ~PUPDR_11(I2C_SDA); 
  GPIOA->PUPDR |= PUPDR_01(I2C_SCL) | PUPDR_01(I2C_SDA); 

  
  GPIOA->AFR[1] &= ~AFRH(I2C_SCL,) & ~AFRH(I2C_SDA,);
  GPIOA->AFR[1] |= AFRH(I2C_SCL,4) | AFRH(I2C_SDA,4);
  
  NVIC_EnableIRQ(I2C1_IRQn);
  
  I2C1->CR1 |= I2C_CR1_STOPIE;
  I2C1->CR1 |= I2C_CR1_NACKIE;
  I2C1->CR1 |= I2C_CR1_TCIE;

  
  I2C1->TIMINGR = (uint32_t)0x00100001;
 // I2C1->TIMINGR = (uint32_t)0x00201D2B;

  I2C1->CR1 |= I2C_CR1_PE;
  
}

void I2C1_IRQHandler(void) {
  if ((I2C1->ISR & I2C_ISR_TCR) == I2C_ISR_TCR) {
   I2C1->CR2 |=  (1 << 16);
  }

  I2C1->ICR |= I2C_ICR_STOPCF;
  GPIOA->BSRR |= BS(TEST);
  
}


void SysTick_Handler(void) { /* (2) */
 lcd_on ^= 1;
}